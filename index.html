<!DOCTYPE html>
<html lang="id">
<head>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/tewetech/keuanganplampang2/refs/heads/main/favicon-uang.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keuangan Kita | By Tewe Tech</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ================================================= */
        /* === Variabel dan Gaya Dasar Tema (Theme Variables and Base Styles) === */
        /* ================================================= */
        :root {
            /* Warna Dasar (Base Colors) */
            --bg-primary: #f0f0f5; /* Latar Belakang Utama */
            --bg-card: rgba(255, 255, 255, 0.5); /* Latar Belakang Kartu Glassmorphism */
            --text-main: #333333; /* Teks Utama */
            --text-subtle: #666666; /* Teks Sekunder/Subtil */
            --accent-1: #08978b; /* Primer/Simpan (Hijau Teal) */
            --accent-2: #ff6932; /* Hapus (Oranye) */
            --accent-3: #08978B; /* Tab Aktif/Edit/Salin (Sama dengan accent-1) */
            --border-color: rgba(0, 0, 0, 0.1); /* Warna Batas */
            
            /* Dimensi (Dimensions) */
            --glass-br: 8px; /* Radius Sudut Glassmorphism */
            --font-size-base: 0.75rem; /* Ukuran Font Dasar */
            
            /* Shadow & Warna Aksi (Shadow & Action Colors) */
            --shadow-light: rgba(0, 0, 0, 0.1); /* Bayangan Ringan */
            --color-delete: var(--accent-2); /* Warna Hapus */
            --color-save: var(--accent-1); /* Warna Simpan */
            --color-edit: var(--accent-3); /* Warna Edit */
            
            /* Warna khusus untuk Saldo */
            --color-pemasukan: var(--accent-1); /* Warna Hijau untuk Pemasukan */
            --color-pengeluaran: var(--accent-2); /* Warna Oranye untuk Pengeluaran */
            --color-net-saldo: #007bff; /* Warna Biru untuk Saldo Akhir Kategori */
            --color-global-saldo: #4a5568; /* Warna Abu-abu Tua untuk Saldo Global */
        }

        /* --- Gaya Umum untuk body (General body Style) --- */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            min-height: 100vh;
            padding: 1em; 
            font-size: var(--font-size-base); 
        }
        
        /* --- Kontainer utama (glass-card) - Glassmorphism style --- */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(6px) saturate(180%); 
            -webkit-backdrop-filter: blur(6px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 9px var(--shadow-light); 
            padding: 1em; 
            border-radius: var(--glass-br);
        }

        /* --- Kontainer Utama untuk batasan lebar (main-container) --- */
        .main-container {
            max-width: 540px; 
            margin-left: auto;
            margin-right: auto;
            space-y: 0.8em; 
        }
        
        /* --- Tombol Aksi Utama (btn-primary - untuk tombol Tambah Baru) --- */
        .btn-primary {
            background-color: var(--color-save); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            padding: 0.5rem 1rem; 
            font-size: 0.6rem; 
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #046c63; 
            transform: translateY(-1px);
        }
        
        /* === Gaya Tombol Hapus (btn-delete - untuk Modal Hapus) === */
        .btn-delete {
            background-color: var(--color-delete); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            box-shadow: 0 1px 4px rgba(255, 105, 50, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-delete:hover:not(:disabled) {
            background-color: #e04a1f; 
            transform: translateY(-1px);
        }

        /* --- Tombol Aksi Tabel (Edit/Hapus/Simpan/Batal Inline) --- */
        /* Kontainer tombol aksi tabel, menggunakan flex untuk sejajar */
        .table-action-container {
            display: flex;
            gap: 0.25rem; /* Jarak antar tombol */
            justify-content: center;
            align-items: center;
        }
        .btn-table-action {
            /* Membuat tombol lebih kecil dan merata */
            font-size: 0.6rem; 
            padding: 0.3rem; 
            width: 1.6rem; 
            height: 1.6rem; 
            border-radius: 3px; 
            color: white; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        /* --- Gaya Input dan Select (Input and Select Styles) --- */
        .gaya-input-theme {
            border: 1px solid var(--border-color);
            border-radius: 5px; 
            padding: 0.5rem; 
            font-size: 0.6rem; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #fcfcfc;
        }

        /* --- Gaya Tabel (Table Styles) --- */
        .data-table thead th {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-subtle);
            font-weight: 600;
            font-size: 0.6rem; 
            padding: 0.5rem 0.6rem; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
            text-align: center;
        }
        
        .data-table tbody td {
            padding: 0.5rem 0.6rem; 
            font-size: 0.6rem; 
            vertical-align: middle; 
            color: var(--text-main); 
            text-align: left;
        }
        
        /* --- Pengaturan Rata Tengah/Kanan untuk Isi Kolom (Column Content Alignment) --- */
        .data-table tbody td:nth-child(2) { text-align: center; } /* TANGGAL */
        .data-table tbody td:nth-child(3) { text-align: left; } /* KETERANGAN (Deskripsi) */
        .data-table tbody td:nth-child(4), /* PEMASUKAN */
        .data-table tbody td:nth-child(5), /* PENGELUARAN */
        .data-table tbody td:nth-child(6) { 
            text-align: right; /* Rata Kanan untuk nominal uang */
        }
        .data-table tbody td:nth-child(7) { text-align: center; } /* AKSI */


        /* Mengganti baris ganjil/genap dengan gaya default agar lebih bersih */
        .data-table tbody tr:nth-child(odd) { background-color: white; }
        .data-table tbody tr:nth-child(even) { background-color: var(--bg-primary); }
        .data-table tbody tr:hover { background-color: #e3f2fd; }

        /* --- Gaya Scrollable Data (Scrollable Data Style) --- */
        .scrollable-data {
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color);
            border-radius: var(--glass-br);
        }

        /* --- Gaya Tombol Kategori (Mengganti Tombol Bulan) --- */
        .btn-month-theme {
            padding: 0.4rem 0.6rem; 
            font-weight: 500; 
            border-radius: 5px; 
            color: var(--text-subtle);
            font-size: 0.6rem; 
            transition: all 0.2s ease;
            background-color: #e0e0e0; 
            border: 1px solid var(--border-color);
        }
        .btn-month-theme:hover { 
            background-color: #ccc; 
            color: var(--text-main); 
            transform: translateY(-1px);
        }
        .btn-month-theme.aktif {
            background-color: var(--accent-1); 
            color: white;
            border-color: var(--accent-1);
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
        }
        .btn-month-theme.aktif:hover {
            background-color: var(--accent-1); 
            color: white;
        }

        /* --- Gaya Modal (Modal Loading/Hapus) --- */
        .modal {
            transition: all 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
            display: flex; 
        }
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            padding: 1.2em; 
            transform: translateY(-15px); 
            transition: transform 0.3s ease-out;
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* --- Gaya Baris Input/Edit (New Input/Edit Row Styles) --- */
        #baris-input-baru {
            background-color: #e6fffb !important; /* Warna latar belakang tema: Minty */
        }
        .baris-edit-aktif {
            background-color: #fffbe6 !important; /* Warna latar belakang tema: Kuning lembut */
        }
        
        /* Gaya tambahan untuk menyembunyikan Kolom ID Transaksi (Hide Transaction ID Column) */
        .hidden-ts-col {
            display: none;
        }

        /* --- Gaya Khusus Kartu Saldo Revisi --- */
        .balance-item p {
            font-size: 0.55rem; /* Ukuran font label saldo */
            font-weight: 500;
            margin-bottom: 0.1rem;
        }

        /* REVISI: Perkecil Ukuran Font Nilai Saldo Kategori */
        .balance-item .balance-value {
            font-size: 0.55rem; /* Diperkecil dari 0.75rem ke 0.95rem - Awalnya 0.75rem */
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Tambahan: Gaya khusus untuk Sisa Saldo Semua Kategori */
        #sisaSaldoSemuaKategori {
            font-size: 0.99rem; /* Ukuran font lebih besar untuk saldo akhir global */
            font-weight: 800;
            color: var(--color-global-saldo);
        }
        
        /* Mengubah totalPemasukan dan totalPengeluaran kembali ke ukuran standar */
        #totalPemasukan { color: var(--color-pemasukan); }
        #totalPengeluaran { color: var(--color-pengeluaran); }
        
        /* Gaya untuk Saldo Akhir Kategori Ini */
        #akhirSaldoKategori {
            /* font-size diatur oleh .balance-value di atas */
        }
        
    </style>
</head>
<body>

    <div class="main-container mx-auto p-4 space-y-4"> 
        
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-extrabold text-[var(--accent-1)]">
                <i class="fas fa-chart-line mr-2"></i> KEUANGAN KITA
            </h1>
            <p class="text-[var(--text-subtle)] mt-1 font-['JetBrains_Mono',_monospace] text-xs">
                Keuangan Kita | By Tewe Tech
            </p>
        </header>

        <div class="glass-card p-4 mb-4">
            <div class="mb-4">
                <p class="text-sm font-bold text-[var(--text-main)] mb-2">
                    <i class="fas fa-filter mr-2"></i> Pilih Kategori :
                </p>
                <div id="filterBulanContainer" class="grid grid-cols-2 md:grid-cols-3 gap-1.5">
                </div>
            </div>

            <div id="kartuSaldo" class="glass-card p-4 rounded-xl shadow-inner transition duration-300">
                <p class="text-xs opacity-90 font-['JetBrains_Mono',_monospace] text-gray-500 mb-3 text-center">RINGKASAN KEUANGAN KATEGORI INI:</p>
                
                <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                    
                    <div class="balance-item border-r border-gray-200 pr-2">
                        <p class="text-[var(--color-pemasukan)]"><i class="fas fa-arrow-up-long mr-1"></i></p>
                        <p id="totalPemasukan" class="balance-value">Rp 0</p>
                    </div>

                    <div class="balance-item border-r border-gray-200 px-2">
                        <p class="text-[var(--color-pengeluaran)]"><i class="fas fa-arrow-down-long mr-1"></i></p>
                        <p id="totalPengeluaran" class="balance-value">Rp 0</p>
                    </div>
                    
                    <div class="balance-item pl-2">
                        <p class="text-[var(--color-net-saldo)]"><i class="fas fa-balance-scale-left mr-1"></i></p>
                        <p id="akhirSaldoKategori" class="balance-value">Rp 0</p>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-3 text-center">
                    <p class="text-sm font-bold text-[var(--text-main)] mb-1">SISA SALDO SEMUA KATEGORI:</p>
                    <p id="sisaSaldoSemuaKategori" class="font-extrabold mt-1 font-['JetBrains_Mono',_monospace]">Rp 0</p>
                </div>
            </div>
        </div>

        <div class="glass-card p-4 overflow-x-auto relative">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg md:text-xl font-semibold text-[var(--text-main)]">
                    <i class="fas fa-receipt mr-2"></i> Rincian :
                </h2>
                <div class="flex space-x-2">
                    <button 
                        id="tombolSimpanCsv" 
                        class="btn-primary flex items-center justify-center text-xs rounded-full transform transition duration-200"
                        style="width: 30px; height: 30px; font-size: 0.65rem; padding: 0;"
                        title="Simpan Data Transaksi Kategori Ini ke CSV"
                        onclick="exportToCSV()"
                    >
                        <i class="fas fa-download"></i>
                    </button>
                    <button 
                        id="tombolTambahBaru" 
                        class="btn-primary rounded-full flex items-center justify-center transform transition duration-200" 
                        title="Tambah Transaksi Baru"
                        style="width: 30px; height: 30px; font-size: 0.65rem; padding: 0;"
                        onclick="addRowToTable()"
                    >
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto scrollable-data shadow-inner bg-white bg-opacity-80">
                <table class="min-w-full data-table border-collapse">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2 text-xs uppercase tracking-wider hidden-ts-col">ID TRANSAKSI (TS)</th> 
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">TANGGAL</th>
                            <th class="px-6 py-2 text-center text-xs uppercase tracking-wider">KETERANGAN</th> 
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">PEMASUKAN</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">PENGELUARAN</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">SALDO</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="tabelDataTransaksi" class="divide-y divide-[var(--border-color)]">
                        <tr><td colspan="7" class="text-center py-4 text-[var(--text-subtle)]">Silakan pilih kategori di atas.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="lapisanMemuat" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-full max-w-xs">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-[var(--accent-1)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm font-medium text-[var(--text-main)]">Memuat Data...</span>
            </div>
        </div>
    </div>

    <div id="wadahToast" class="fixed bottom-4 right-4 space-y-2 z-50">
    </div>

    <div id="modalHapus" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-11/12 max-w-xs">
            <h3 class="text-lg font-bold mb-3 flex items-center text-[var(--color-delete)]">
                <i class="fas fa-exclamation-triangle mr-2"></i> Konfirmasi Penghapusan
            </h3>
            <p id="modalPesan" class="mb-4 text-[var(--text-main)] text-sm">Anda yakin ingin menghapus transaksi ini?</p>
            <div class="flex justify-end space-x-2">
                <button id="tombolBatalHapus" class="bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md text-sm hover:bg-gray-300 transition duration-150">
                    <i class="fas fa-times mr-1"></i> Batal
                </button>
                <button id="tombolKonfirmasiHapus" class="btn-delete text-white font-semibold py-1.5 px-3 rounded-md shadow-md hover:shadow-lg transition duration-150 ease-in-out text-sm">
                    <i class="fas fa-trash-alt mr-1"></i> Ya, Hapus
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // KONFIGURASI APLIKASI (APPLICATION CONFIGURATION)
        // ====================================================================
        
        // URL DEPLOYMENT Apps Script Anda (WAJIB DIGANTI dengan URL TERBARU Anda)
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyBExQoFr8APOO95FzJGLe6ehemqG0IK4qYpQwLJogT3nORec5e1ONtLl5uyx_Ps4rs2A/exec"; // <-- WAJIB GANTI INI

        // DAFTAR KATEGORI BARU UNTUK FILTER UTAMA (Nama Sheet di Spreadsheet)
        const CATEGORY_DATA = ["Mahar", "Mas Kawin", "Seserahan", "Souvenir", "Undangan", "Lain Lain"];
        
        // Variabel Status Aplikasi
        let isEditing = false; // Status apakah sedang dalam mode edit baris
        let isAddingNew = false; // Status apakah sedang dalam mode tambah baru
        let originalRowContent = null; // Menyimpan konten baris asli saat edit
        let currentSelectedCategory = CATEGORY_DATA[0]; // Kategori/Sheet yang saat ini dipilih (default: Mahar)
        let transactionIdToDelete = null; // ID transaksi yang akan dihapus
        
        // Variabel Saldo Baru (Revisi)
        let finalBalanceCategoryValue = 0; // Nilai Saldo Akhir Kategori (Perubahan nama)
        let totalIncomeValue = 0; // Nilai Total Pemasukan Kategori
        let totalExpenseValue = 0; // Nilai Total Pengeluaran Kategori
        let globalFinalBalanceValue = 0; // Nilai Sisa Saldo Semua Kategori (Baru)
        
        // Referensi DOM
        const filterBulanContainer = document.getElementById('filterBulanContainer'); // Kontainer tombol Kategori
        const tabelDataTransaksi = document.getElementById('tabelDataTransaksi');     // Body tabel transaksi
        const lapisanMemuat = document.getElementById('lapisanMemuat');             // Modal loading
        
        // Referensi DOM Saldo Baru (Revisi)
        const akhirSaldoKategoriEl = document.getElementById('akhirSaldoKategori'); // Elemen saldo akhir kategori
        const totalPemasukanEl = document.getElementById('totalPemasukan');         // Elemen total pemasukan
        const totalPengeluaranEl = document.getElementById('totalPengeluaran');     // Elemen total pengeluaran
        const sisaSaldoSemuaKategoriEl = document.getElementById('sisaSaldoSemuaKategori'); // Elemen saldo akhir global
        
        const tombolTambahBaru = document.getElementById('tombolTambahBaru');         // Tombol tambah baru
        const wadahToast = document.getElementById('wadahToast');                     // Wadah notifikasi toast
        const modalHapus = document.getElementById('modalHapus');                     // Modal konfirmasi hapus
        const tombolKonfirmasiHapus = document.getElementById('tombolKonfirmasiHapus'); // Tombol konfirmasi hapus di modal
        const tombolBatalHapus = document.getElementById('tombolBatalHapus');           // Tombol batal hapus di modal
        const tombolSimpanCsv = document.getElementById('tombolSimpanCsv');         // Tombol export CSV

        // ====================================================================
        // FUNGSI UTILITY & API CALLS (HELPER FUNCTIONS)
        // ====================================================================

        /** Mengirim data ke Google Apps Script (Apps Script Communication) */
        async function postToGS(data) {
            showLoading(true);
            const url = GOOGLE_APPS_SCRIPT_URL; 
            const MAX_RETRIES = 3; // Maksimal percobaan ulang

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const formData = new FormData();
                    for (const key in data) {
                        // Konversi angka ke string untuk FormData
                        formData.append(key, typeof data[key] === 'number' ? String(data[key]) : data[key]);
                    }

                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow',
                        mode: 'cors'
                    });

                    if (!response.ok) {
                         // Tangani response non-200 OK
                        throw new Error(`Permintaan HTTP gagal dengan status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === 'error') {
                        throw new Error(result.message || 'Operasi gagal di sisi server.');
                    }
                    showLoading(false);
                    return result;

                } catch (error) {
                    console.error("Kesalahan saat menghubungi Apps Script:", error);
                    if (i === MAX_RETRIES - 1) {
                        showLoading(false);
                        throw new Error(`Gagal memproses data setelah ${MAX_RETRIES} percobaan: ${error.message}`);
                    }
                    // Eksponensial backoff
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay)); 
                }
            }
        }

        /** Mengambil sisa saldo semua kategori dari Apps Script (NEW FUNCTION) */
        async function fetchGlobalBalance() {
             try {
                // Menggunakan aksi 'READ_ALL_BALANCE' yang baru di Apps Script
                const result = await postToGS({ action: 'READ_ALL_BALANCE', month: currentSelectedCategory }); 
                globalFinalBalanceValue = parseFloat(result.totalSaldo) || 0;
                updateSaldoDisplay();
            } catch (error) {
                console.error("Gagal memuat saldo global:", error);
                globalFinalBalanceValue = 0; // Reset jika gagal
                updateSaldoDisplay();
                showToast(`Gagal memuat saldo global: ${error.message}`, 'error');
            }
        }


        /** Menampilkan notifikasi toast (Show Toast Notification) */
        function showToast(message, type) {
            const container = wadahToast;
            let bgColor;
            let icon;
            
            if (type === 'success') {
                bgColor = 'bg-[var(--accent-1)]'; icon = 'fa-check-circle';
            } else if (type === 'accent-3') {
                bgColor = 'bg-[#3b82f6]'; icon = 'fa-info-circle';
            } else { // error
                bgColor = 'bg-[var(--accent-2)]'; icon = 'fa-exclamation-circle';
            }

            const toast = document.createElement('div');
            toast.className = `p-2 rounded-lg shadow-xl ${bgColor} text-white transition-all transform duration-500 translate-y-2 opacity-0 flex items-center space-x-2 text-sm`;
            toast.innerHTML = `<i class="fas ${icon} text-lg"></i> <div> <p class="font-bold">${type === 'success' ? 'BERHASIL' : (type === 'accent-3' ? 'PERHATIAN' : 'GAGAL')}</p> <p class="mt-0.5 text-xs">${message}</p> </div>`;
            container.appendChild(toast);

            // Tampilkan toast
            setTimeout(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            }, 50); 
            
            // Sembunyikan dan hapus toast setelah 5 detik
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => { toast.remove(); }, 500);
            }, 5000);
        }

        /** Menampilkan atau menyembunyikan lapisan memuat (Show/Hide Loading Overlay) */
        function showLoading(state) {
            lapisanMemuat.classList.toggle('hidden', !state);
            lapisanMemuat.classList.toggle('modal-open', state);
        }

        /** Format angka menjadi format Rupiah (Format Number to Rupiah) */
        function formatRupiah(angka) {
            if (typeof angka !== 'number' && typeof angka !== 'string') return 'Rp 0';
            const num = typeof angka === 'string' ? parseFloat(angka) : angka;
            if (isNaN(num)) return 'Rp 0';

            const sign = num < 0 ? '-' : '';
            const absoluteAngka = Math.abs(num);
            const formatter = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            });
            // Hapus spasi setelah 'Rp' jika ada dan tambahkan tanda minus di depan jika negatif
            return sign + formatter.format(absoluteAngka).trim();
        }

        /** Mengubah string Rupiah menjadi angka (Parse Rupiah String to Number) */
        function parseRupiah(rupiahString) {
            // Hapus 'Rp', titik sebagai ribuan, dan koma desimal
            const cleanString = rupiahString.replace(/[^0-9,-]/g, '').replace(',', '.'); 
            const number = parseFloat(cleanString);
            return isNaN(number) ? 0 : number;
        }

        /** Mengubah format tanggal dari YYYY-MM-DD menjadi DD Bulan YYYY (Format Date to Indonesian) */
        function formatDateToIndonesian(dateString) {
            if (!dateString) return '';
            try {
                // Asumsi dateString sudah dalam format YYYY-MM-DD dari spreadsheet
                const parts = dateString.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (!parts) return dateString;

                // Membuat objek Date dengan komponen terpisah untuk menghindari pergeseran zona waktu
                const date = new Date(parts[1], parts[2] - 1, parts[3]);
                
                return date.toLocaleDateString('id-ID', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        /** Mengubah format tanggal dari DD Bulan YYYY menjadi YYYY-MM-DD (untuk input date) (Convert to YYYY-MM-DD) */
        function convertToYyyyMmDd(indonesianDateString) {
            try {
                // Parsing format Indonesia (contoh: 1 Agustus 2025)
                const date = new Date(indonesianDateString.replace(/\s/g, ' '));
                if (isNaN(date)) {
                    return '';
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return '';
            }
        }
        
        /** Helper: Membuat elemen input/date/number/text (Create Input Element) */
        function createInput(type, value, placeholder = '') {
            const input = document.createElement('input');
            
            // Set input type dan gaya dasar
            if (type === 'number') {
                input.type = 'number';
                input.value = value || 0;
                input.min = 0;
                input.className = 'gaya-input-theme w-full text-center';
            } else if (type === 'date') {
                input.type = 'date';
                input.value = value || '';
                input.className = 'gaya-input-theme w-full text-center';
            } else { 
                // Default ke input teks (untuk Keterangan/Deskripsi)
                input.type = 'text';
                input.value = value || '';
                input.className = 'gaya-input-theme w-full text-left'; 
            }
            input.placeholder = placeholder;
            return input;
        }


        // ====================================================================
        // FUNGSI LOGIKA UTAMA (CRUD & UI LOGIC)
        // ====================================================================

        /** Mengambil dan menampilkan data transaksi untuk KATEGORI/SHEET yang dipilih (Fetch and Display Data) */
        async function fetchData(category = currentSelectedCategory) {
            currentSelectedCategory = category; // Simpan kategori baru
            showLoading(true);
            try {
                // Menggunakan parameter 'month' di Apps Script, namun isinya adalah nama kategori/sheet
                const result = await postToGS({ action: 'READ_DATA', month: category });
                
                // Hapus semua baris yang sudah ada
                tabelDataTransaksi.innerHTML = ''; 
                
                const data = result.data || [];
                
                // Variabel lokal untuk menghitung total
                let tempIncome = 0;
                let tempExpense = 0;

                if (data.length === 0) {
                    // Tampilkan pesan "Tidak ada data"
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="7" class="text-center py-4 text-[var(--text-subtle)]">Tidak ada data transaksi untuk kategori ${category}.</td>`;
                    tabelDataTransaksi.appendChild(noDataRow);
                    
                    // Reset semua saldo kategori
                    finalBalanceCategoryValue = 0; 
                    totalIncomeValue = 0;
                    totalExpenseValue = 0;
                } else {
                    // Render data ke tabel dan hitung total pemasukan/pengeluaran
                    data.forEach(rowData => {
                        tabelDataTransaksi.appendChild(createTableRow(rowData));
                        
                        // rowData index 3: pemasukan, index 4: pengeluaran
                        tempIncome += parseFloat(rowData[3]) || 0;
                        tempExpense += parseFloat(rowData[4]) || 0;
                    });
                    
                    // Ambil saldo akhir kategori dari baris terakhir (index 5)
                    finalBalanceCategoryValue = parseFloat(data[data.length - 1][5]) || 0; 
                    totalIncomeValue = tempIncome;
                    totalExpenseValue = tempExpense;
                }
                
                // Muat ulang Saldo Global (Baru)
                await fetchGlobalBalance(); 
                
                updateSaldoDisplay();
                updateCategoryButtons(category); // Perbarui tampilan tombol kategori

            } catch (error) {
                showToast(`Gagal memuat data: ${error.message}`, 'error');
                tabelDataTransaksi.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
                // Reset saldo pada error
                finalBalanceCategoryValue = 0;
                totalIncomeValue = 0;
                totalExpenseValue = 0;
                updateSaldoDisplay();
            } finally {
                showLoading(false);
                isEditing = false;
                isAddingNew = false;
            }
        }

        /** Memperbarui tampilan saldo (Pemasukan, Pengeluaran, Saldo Akhir Kategori, Saldo Global) (Update All Balance Displays) */
        function updateSaldoDisplay() {
            // 1. Update Total Pemasukan
            totalPemasukanEl.textContent = formatRupiah(totalIncomeValue);
            
            // 2. Update Total Pengeluaran
            totalPengeluaranEl.textContent = formatRupiah(totalExpenseValue);

            // 3. Update Saldo Akhir Kategori
            akhirSaldoKategoriEl.textContent = formatRupiah(finalBalanceCategoryValue);
            akhirSaldoKategoriEl.style.color = finalBalanceCategoryValue < 0 ? 'var(--color-delete)' : 'var(--color-net-saldo)';
            
            // 4. Update Sisa Saldo Semua Kategori (Baru)
            sisaSaldoSemuaKategoriEl.textContent = formatRupiah(globalFinalBalanceValue);
            sisaSaldoSemuaKategoriEl.style.color = globalFinalBalanceValue < 0 ? 'var(--color-delete)' : 'var(--color-global-saldo)';
        }

        /** Membuat satu baris tabel (<tr>) dari data transaksi (Create Table Row) */
        function createTableRow(rowData) {
            const [id, tanggal, keterangan, pemasukan, pengeluaran, saldo] = rowData;

            const row = document.createElement('tr');
            row.dataset.id = id;

            // Kolom 1: ID Transaksi (Tersembunyi)
            const tdId = document.createElement('td');
            tdId.className = 'hidden-ts-col';
            tdId.textContent = id;
            row.appendChild(tdId);

            // Kolom 2: TANGGAL
            row.appendChild(createDataCell(formatDateToIndonesian(tanggal), 'text-center'));

            // Kolom 3: KETERANGAN
            row.appendChild(createDataCell(keterangan, 'text-left')); 

            // Kolom 4: PEMASUKAN
            row.appendChild(createDataCell(formatRupiah(pemasukan), 'text-right'));

            // Kolom 5: PENGELUARAN
            row.appendChild(createDataCell(formatRupiah(pengeluaran), 'text-right'));

            // Kolom 6: SALDO
            row.appendChild(createDataCell(formatRupiah(saldo), 'text-right'));

            // Kolom 7: AKSI (Edit, Hapus) - Dibuat sejajar menggunakan div.table-action-container
            const tdAksi = document.createElement('td');
            tdAksi.className = 'text-center';
            tdAksi.innerHTML = `
                <div class="table-action-container">
                    <button
                        class="btn-table-action bg-[var(--color-edit)] hover:bg-opacity-80"
                        title="Edit Transaksi"
                        onclick="startEdit('${id}')"
                    >
                        <i class="fas fa-pen"></i>
                    </button>
                    <button
                        class="btn-table-action bg-[var(--color-delete)] hover:bg-opacity-80"
                        title="Hapus Transaksi"
                        onclick="showDeleteConfirmation('${id}')"
                    >
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            row.appendChild(tdAksi);

            return row;
        }

        /** Helper untuk membuat sel data biasa (Create Standard Data Cell) */
        function createDataCell(content, extraClass = '') {
            const td = document.createElement('td');
            td.textContent = content;
            td.className = extraClass;
            return td;
        }

        /** Menambahkan baris input baru di awal tabel untuk transaksi baru. (Add New Input Row) */
        function addRowToTable() {
            if (isAddingNew || isEditing) {
                showToast("Selesaikan input/edit yang aktif terlebih dahulu.", 'accent-3');
                return;
            }

            isAddingNew = true;

            const newRow = document.createElement('tr');
            newRow.id = 'baris-input-baru';
            newRow.dataset.id = 'NEW';

            // Td ID (tersembunyi)
            newRow.innerHTML += '<td class="hidden-ts-col">NEW</td>';

            // 1. TANGGAL
            const tanggalTd = document.createElement('td');
            const today = new Date().toISOString().split('T')[0];
            const tanggalInput = createInput('date', today);
            tanggalTd.appendChild(tanggalInput);
            newRow.appendChild(tanggalTd);

            // 2. KETERANGAN (Input Teks Bebas)
            const keteranganTd = document.createElement('td');
            const keteranganInput = createInput('text', '', 'Contoh: Emas 10 gram'); 
            keteranganTd.appendChild(keteranganInput);
            newRow.appendChild(keteranganTd);

            // 3. PEMASUKAN
            const pemasukanTd = document.createElement('td');
            const pemasukanInput = createInput('number', 0, 'Pemasukan');
            pemasukanTd.appendChild(pemasukanInput);
            newRow.appendChild(pemasukanTd);

            // 4. PENGELUARAN
            const pengeluaranTd = document.createElement('td');
            const pengeluaranInput = createInput('number', 0, 'Pengeluaran');
            pengeluaranTd.appendChild(pengeluaranInput);
            newRow.appendChild(pengeluaranTd);

            // 5. SALDO
            const saldoTd = document.createElement('td');
            saldoTd.textContent = formatRupiah(finalBalanceCategoryValue); // Saldo Akhir kategori sebelumnya
            saldoTd.classList.add('opacity-50', 'italic', 'text-right');
            newRow.appendChild(saldoTd);

            // 6. AKSI - Dibuat sejajar
            const aksiTd = document.createElement('td');
            aksiTd.className = 'text-center';
            aksiTd.innerHTML = `
                <div class="table-action-container">
                    <button
                        class="btn-table-action bg-[var(--color-save)] hover:bg-opacity-80"
                        title="Simpan Transaksi Baru"
                        onclick="saveNewData()"
                    >
                        <i class="fas fa-check"></i>
                    </button>
                    <button
                        class="btn-table-action bg-gray-400 hover:bg-gray-500"
                        title="Batal Input"
                        onclick="cancelAction('NEW')"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            newRow.appendChild(aksiTd);

            // Sisipkan baris baru di awal tbody
            tabelDataTransaksi.insertBefore(newRow, tabelDataTransaksi.firstChild);
            tanggalInput.focus();
        }

        /** Mengaktifkan mode edit pada baris transaksi tertentu. (Start Edit Mode) */
        function startEdit(id) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan input/edit yang aktif terlebih dahulu.", 'accent-3');
                return;
            }

            isEditing = true;
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;

            row.classList.add('baris-edit-aktif');

            // Simpan konten asli
            originalRowContent = row.innerHTML;

            // Ambil sel data (kecuali ID tersembunyi)
            const cells = Array.from(row.querySelectorAll('td:not(.hidden-ts-col)'));
            const dataCells = cells.slice(0, 5); 
            const aksiCell = cells[5]; // Kolom Aksi

            
            // Data saat ini (untuk mengisi nilai default input)
            const currentDate = dataCells[0].textContent; // Tanggal (DD Bulan YYYY)
            const currentKeterangan = dataCells[1].textContent; // Keterangan (Teks Bebas)
            const currentPemasukan = parseRupiah(dataCells[2].textContent); // Pemasukan
            const currentPengeluaran = parseRupiah(dataCells[3].textContent); // Pengeluaran

            // 1. TANGGAL
            const tanggalInput = createInput('date', convertToYyyyMmDd(currentDate));
            dataCells[0].textContent = '';
            dataCells[0].appendChild(tanggalInput);

            // 2. KETERANGAN (Input Teks Bebas)
            const keteranganInput = createInput('text', currentKeterangan);
            dataCells[1].textContent = '';
            dataCells[1].appendChild(keteranganInput);

            // 3. PEMASUKAN
            const pemasukanInput = createInput('number', currentPemasukan);
            dataCells[2].textContent = '';
            dataCells[2].appendChild(pemasukanInput);

            // 4. PENGELUARAN
            const pengeluaranInput = createInput('number', currentPengeluaran);
            dataCells[3].textContent = '';
            dataCells[3].appendChild(pengeluaranInput);

            // 5. SALDO - Non-Editable, hanya tampilan
            dataCells[4].classList.add('opacity-50', 'italic');

            // 6. AKSI - Ganti dengan Simpan & Batal (Dibuat sejajar)
            aksiCell.innerHTML = `
                <div class="table-action-container">
                    <button
                        class="btn-table-action bg-[var(--color-save)] hover:bg-opacity-80"
                        title="Simpan Perubahan"
                        onclick="updateData('${id}')"
                    >
                        <i class="fas fa-check"></i>
                    </button>
                    <button
                        class="btn-table-action bg-gray-400 hover:bg-gray-500"
                        title="Batal Edit"
                        onclick="cancelAction('${id}')"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            tanggalInput.focus();
        }


        /** Menyimpan baris input baru ke Spreadsheet (ADD_TRANSACTION) */
        async function saveNewData() {
            const row = document.getElementById('baris-input-baru');
            if (!row) return;
            
            // Ambil nilai dari input/select
            const tanggal = row.querySelector('input[type="date"]').value;
            // Ambil Keterangan dari input teks (kolom ke-3, index 2)
            const keterangan = row.querySelector('td:nth-child(3) input').value; 
            const pemasukan = parseFloat(row.querySelectorAll('input[type="number"]')[0].value) || 0;
            const pengeluaran = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;
            
            // Cek validitas data
            if (!tanggal || !keterangan) {
                showToast("Harap isi Tanggal dan Keterangan (deskripsi transaksi).", 'accent-3');
                return;
            }

            try {
                const dataToSend = {
                    action: 'ADD_TRANSACTION',
                    month: currentSelectedCategory, // Mengirim nama Kategori sebagai nama Sheet
                    tanggal,
                    keterangan,
                    pemasukan,
                    pengeluaran,
                    sisa_saldo: 0 // Saldo dihitung di server
                };

                await postToGS(dataToSend);
                showToast("Transaksi berhasil ditambahkan!", 'success');
                isAddingNew = false;
                fetchData(currentSelectedCategory); // Muat ulang data & saldo global
            } catch (error) {
                showToast(`Gagal menambahkan: ${error.message}`, 'error');
            }
        }

        /** Memperbarui baris yang diedit di Spreadsheet (UPDATE_TRANSACTION) */
        async function updateData(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;

            // Ambil nilai dari input/select
            const tanggal = row.querySelector('input[type="date"]').value;
            // Ambil Keterangan dari input teks (kolom ke-3, index 2)
            const keterangan = row.querySelector('td:nth-child(3) input').value; 
            const pemasukan = parseFloat(row.querySelectorAll('input[type="number"]')[0].value) || 0;
            const pengeluaran = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;

            if (!tanggal || !keterangan) {
                showToast("Harap isi Tanggal dan Keterangan (deskripsi transaksi).", 'accent-3');
                return;
            }

            try {
                const dataToSend = {
                    action: 'UPDATE_TRANSACTION',
                    id: id,
                    month: currentSelectedCategory, // Mengirim nama Kategori sebagai nama Sheet
                    tanggal,
                    keterangan,
                    pemasukan,
                    pengeluaran,
                    sisa_saldo: 0 // Saldo dihitung ulang di server
                };

                await postToGS(dataToSend);
                showToast("Transaksi berhasil diperbarui!", 'success');
                isEditing = false;
                fetchData(currentSelectedCategory); // Muat ulang data & saldo global
            } catch (error) {
                showToast(`Gagal memperbarui: ${error.message}`, 'error');
            }
        }

        /** Menampilkan modal konfirmasi hapus (Show Delete Confirmation Modal) */
        function showDeleteConfirmation(id) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan input/edit yang aktif terlebih dahulu.", 'accent-3');
                return;
            }
            transactionIdToDelete = id;
            modalHapus.classList.remove('hidden');
            modalHapus.classList.add('modal-open');
        }

        /** Menghapus transaksi (DELETE_TRANSACTION) */
        async function deleteTransaction() {
            modalHapus.classList.remove('modal-open');
            modalHapus.classList.add('hidden');

            if (!transactionIdToDelete) return;

            try {
                await postToGS({ 
                    action: 'DELETE_TRANSACTION', 
                    id: transactionIdToDelete,
                    month: currentSelectedCategory // Mengirim nama Kategori sebagai nama Sheet
                });
                showToast("Transaksi berhasil dihapus!", 'success');
                transactionIdToDelete = null;
                fetchData(currentSelectedCategory); // Muat ulang data & saldo global
            } catch (error) {
                showToast(`Gagal menghapus: ${error.message}`, 'error');
            }
        }

        /** Membatalkan mode edit atau input baru (Cancel Edit or New Input Action) */
        function cancelAction(id) {
            if (id === 'NEW') {
                // Hapus baris input baru
                const newRow = document.getElementById('baris-input-baru');
                if (newRow) newRow.remove();
                isAddingNew = false;
            } else {
                // Batalkan edit, kembalikan konten asli
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row && originalRowContent) {
                    row.innerHTML = originalRowContent;
                    row.classList.remove('baris-edit-aktif');
                    isEditing = false;
                    originalRowContent = null;
                }
            }
        }


        // ====================================================================
        // FUNGSI INISIALISASI & UI (INITIALIZATION & UI FUNCTIONS)
        // ====================================================================

        /** Membuat tombol Kategori (sebelumnya tombol bulan) (Create Category Button) */
        function createCategoryButton(categoryName) {
            const button = document.createElement('button');
            button.textContent = categoryName; // Tampilkan nama kategori penuh
            button.className = 'btn-month-theme text-xs'; 
            button.onclick = () => fetchData(categoryName);
            return button;
        }

        /** Memperbarui tampilan tombol Kategori yang aktif (Update Active Category Button) */
        function updateCategoryButtons(activeCategory) {
            Array.from(filterBulanContainer.children).forEach(btn => {
                btn.classList.toggle('aktif', btn.textContent === activeCategory);
            });
        }
        
        /** Export data tabel ke format CSV (Export Table to CSV) */
        function exportToCSV() {
            const table = document.querySelector('.data-table');
            if (!table) return;

            let csv = [];
            
            // Ambil Header
            const headers = Array.from(table.querySelectorAll('thead th:not(.hidden-ts-col)'))
                                .map(th => th.textContent.trim());
            csv.push(headers.join(';'));
            
            // Ambil Data Baris
            table.querySelectorAll('tbody tr').forEach(row => {
                // Skip baris input/edit baru
                if (row.id === 'baris-input-baru') return; 
                // Ambil semua sel data (kecuali yang tersembunyi)
                const rowData = Array.from(row.querySelectorAll('td:not(.hidden-ts-col)'))
                                        .slice(0, 6) // Hanya 6 kolom data (Tanggal s.d. Saldo)
                                        .map(td => td.textContent.trim().replace(formatRupiah(0).slice(0,-3), '')); // Hapus simbol Rupiah/spasi

                if (rowData.length === 6) {
                     // Pastikan koma desimal diganti menjadi titik untuk standar CSV
                    const formattedData = rowData.map(d => d.replace(/\./g, '').replace(',', '.')); 
                    csv.push(formattedData.join(';'));
                }
            });

            if (csv.length <= 1) {
                showToast(`Tidak ada data untuk diekspor di kategori ${currentSelectedCategory}.`, 'accent-3');
                return;
            }

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            // Nama file: Keuangan_Kategori.csv
            link.setAttribute("href", url);
            link.setAttribute("download", `Keuangan_${currentSelectedCategory}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Data berhasil diekspor ke CSV!", 'success');
        }


        /** Fungsi untuk inisialisasi awal saat halaman dimuat (Initial Function Call) */
        function initialize() {
            // 1. Buat tombol Kategori
            CATEGORY_DATA.forEach(category => {
                filterBulanContainer.appendChild(createCategoryButton(category));
            });

            // 2. Set event listener untuk konfirmasi hapus
            tombolKonfirmasiHapus.onclick = deleteTransaction;
            tombolBatalHapus.onclick = () => {
                modalHapus.classList.remove('modal-open');
                modalHapus.classList.add('hidden');
                transactionIdToDelete = null;
            };

            // 3. Muat data untuk kategori default (Mahar) dan Saldo Global
            fetchData();
        }

        // Jalankan inisialisasi setelah DOM dimuat
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Expose fungsi ke scope global agar bisa diakses dari atribut onclick di HTML
        window.startEdit = startEdit;
        window.showDeleteConfirmation = showDeleteConfirmation;
        window.addRowToTable = addRowToTable;
        window.cancelAction = cancelAction;
        window.updateData = updateData; 
        window.saveNewData = saveNewData; 
        window.exportToCSV = exportToCSV; 

    </script>
</body>
</html>
