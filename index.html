<!DOCTYPE html>
<html lang="id">
<head>
    <!-- Favicon dari repository -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/tewetech/keuanganplampang2/refs/heads/main/favicon-uang.png">
    <meta charset="UTF-8">
    <!-- Pengaturan viewport agar responsif di HP -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persiapan Wedding | By Tewe Tech</title>
    
    <!-- Memuat Tailwind CSS (Framework Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat Font Google: Poppins dan JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

    <!-- Memuat Ikon FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS Kustom untuk Desain Spesifik -->
    <style>
        /* Variabel Warna dan Styling Dasar */
        :root {
            --bg-primary: #f0f0f5; 
            --bg-card: rgba(255, 255, 255, 0.5); 
            --text-main: #333333; 
            --text-subtle: #666666; 
            --accent-1: #08978b; /* Hijau Tosca Gelap */
            --accent-2: #ff6932; /* Oranye Kemerahan */
            --accent-3: #08978B; 
            --border-color: rgba(0, 0, 0, 0.1); 
            
            --glass-br: 8px; /* Radius sudut elemen kaca */
            --font-size-base: 0.75rem; 
            
            --shadow-light: rgba(0, 0, 0, 0.1); 
            --color-delete: var(--accent-2); 
            --color-save: var(--accent-1); 
            --color-edit: var(--accent-3); 
            
            --color-pemasukan: var(--accent-1); 
            --color-pengeluaran: var(--accent-2); 
            --color-net-saldo: #007bff; 
            --color-global-saldo: #4a5568; 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-main);
            min-height: 100vh;
            padding: 1em; 
            font-size: var(--font-size-base); 
        }
        
        /* Efek Kaca (Glassmorphism) */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(6px) saturate(180%); 
            -webkit-backdrop-filter: blur(6px) saturate(180%);
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 9px var(--shadow-light); 
            padding: 1em; 
            border-radius: var(--glass-br);
        }

        .main-container {
            max-width: 540px; /* Lebar maksimal agar enak dilihat di desktop */
            margin-left: auto;
            margin-right: auto;
            space-y: 0.8em; 
        }
        
        /* Styling Tombol Utama */
        .btn-primary {
            background-color: var(--color-save); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            padding: 0.5rem 1rem; 
            font-size: 0.6rem; 
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #046c63; 
            transform: translateY(-1px);
        }
        
        /* Styling Tombol Hapus */
        .btn-delete {
            background-color: var(--color-delete); 
            color: white;
            font-weight: 600;
            border-radius: 5px; 
            box-shadow: 0 1px 4px rgba(255, 105, 50, 0.3); 
            transition: background-color 0.2s, transform 0.2s;
        }
        .btn-delete:hover:not(:disabled) {
            background-color: #e04a1f; 
            transform: translateY(-1px);
        }

        /* Kontainer Aksi Tabel (Edit/Hapus) */
        .table-action-container {
            display: flex;
            gap: 0.25rem; 
            justify-content: center;
            align-items: center;
        }
        .btn-table-action {
            font-size: 0.6rem; 
            padding: 0.3rem; 
            width: 1.6rem; 
            height: 1.6rem; 
            border-radius: 3px; 
            color: white; 
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, transform 0.2s;
        }

        /* Styling Input Form */
        .gaya-input-theme {
            border: 1px solid var(--border-color);
            border-radius: 5px; 
            padding: 0.5rem; 
            font-size: 0.6rem; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            background-color: #fcfcfc;
        }

        /* Styling Header Tabel */
        .data-table thead th {
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-subtle);
            font-weight: 600;
            font-size: 0.6rem; 
            padding: 0.5rem 0.6rem; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            background-color: white; 
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05); 
            text-align: center;
        }
        
        /* Styling Isi Tabel */
        .data-table tbody td {
            padding: 0.5rem 0.6rem; 
            font-size: 0.6rem; 
            vertical-align: middle; 
            color: var(--text-main); 
            text-align: left;
        }
        
        /* Penyesuaian Alignment Kolom */
        .data-table tbody td:nth-child(2) { text-align: center; } /* Tanggal */
        .data-table tbody td:nth-child(3) { text-align: left; }   /* Keterangan */
        .data-table tbody td:nth-child(4), 
        .data-table tbody td:nth-child(5) { 
            text-align: right; /* Angka Rupiah rata kanan */
        }
        .data-table tbody td:nth-child(6) { text-align: center; } /* Aksi */


        /* Warna selang-seling baris tabel */
        .data-table tbody tr:nth-child(odd) { background-color: white; }
        .data-table tbody tr:nth-child(even) { background-color: var(--bg-primary); }
        .data-table tbody tr:hover { background-color: #e3f2fd; }

        /* Area Scroll Tabel */
        .scrollable-data {
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid var(--border-color);
            border-radius: var(--glass-br);
        }

        /* Tombol Kategori/Bulan */
        .btn-month-theme {
            padding: 0.4rem 0.6rem; 
            font-weight: 500; 
            border-radius: 5px; 
            color: var(--text-subtle);
            font-size: 0.6rem; 
            transition: all 0.2s ease;
            background-color: #e0e0e0; 
            border: 1px solid var(--border-color);
        }
        .btn-month-theme:hover { 
            background-color: #ccc; 
            color: var(--text-main); 
            transform: translateY(-1px);
        }
        .btn-month-theme.aktif {
            background-color: var(--accent-1); 
            color: white;
            border-color: var(--accent-1);
            box-shadow: 0 1px 4px rgba(8, 151, 139, 0.3); 
        }
        .btn-month-theme.aktif:hover {
            background-color: var(--accent-1); 
            color: white;
        }

        /* Modal Pop-up */
        .modal {
            transition: all 0.3s ease-out;
            opacity: 0;
            pointer-events: none;
            display: flex; 
        }
        .modal-open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: white;
            border-radius: 10px; 
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            padding: 1.2em; 
            transform: translateY(-15px); 
            transition: transform 0.3s ease-out;
        }
        .modal-open .modal-content {
            transform: translateY(0);
        }

        /* Highlight baris input baru dan edit */
        #baris-input-baru {
            background-color: #e6fffb !important; 
        }
        .baris-edit-aktif {
            background-color: #fffbe6 !important; 
        }
        
        /* Sembunyikan kolom ID Transaksi */
        .hidden-ts-col {
            display: none;
        }

        /* Item Saldo di Ringkasan */
        .balance-item p {
            font-size: 0.55rem; 
            font-weight: 500;
            margin-bottom: 0.1rem;
        }

        .balance-item .balance-value {
            font-size: 0.55rem; 
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        #sisaSaldoSemuaKategori {
            font-size: 0.99rem; 
            font-weight: 800;
            color: var(--color-global-saldo);
        }
        
        #totalPemasukan { color: var(--color-pemasukan); }
        #totalPengeluaran { color: var(--color-pengeluaran); }
        
    </style>
</head>
<body>

    <div class="main-container mx-auto p-4 space-y-4"> 
        
        <!-- HEADER -->
        <header class="text-center mb-6">
            <h1 class="text-2xl md:text-3xl font-extrabold text-[var(--accent-1)]">
                <i class="fas fa-chart-line mr-2"></i> PERSIAPAN WEDDING
            </h1>
            <p class="text-[var(--text-subtle)] mt-1 font-['JetBrains_Mono',_monospace] text-xs">
                Persiapan Wedding | By Tewe Tech V1.4
            </p>
        </header>

        <!-- AREA KARTU UTAMA -->
        <div class="glass-card p-4 mb-4">
            <!-- Pilihan Kategori -->
            <div class="mb-4">
                <p class="text-sm font-bold text-[var(--text-main)] mb-2">
                    <i class="fas fa-filter mr-2"></i> Pilih Kategori :
                </p>
                <div id="filterBulanContainer" class="grid grid-cols-2 md:grid-cols-3 gap-1.5">
                    <!-- Tombol Kategori akan dibuat lewat JS -->
                </div>
            </div>

            <!-- Ringkasan Saldo -->
            <div id="kartuSaldo" class="glass-card p-4 rounded-xl shadow-inner transition duration-300">
                <p class="text-xs opacity-90 font-['JetBrains_Mono',_monospace] text-gray-500 mb-3 text-center">RINGKASAN KEUANGAN KATEGORI INI</p>
                
                <div class="grid grid-cols-3 gap-3 mb-4 text-center">
                    <!-- Total Masuk -->
                    <div class="balance-item border-r border-gray-200 pr-2">
                        <p class="text-[var(--color-pemasukan)]"><i class="fas fa-arrow-down-long mr-1"> M A S U K</i></p>
                        <p id="totalPemasukan" class="balance-value">0</p>
                    </div>

                    <!-- Total Keluar -->
                    <div class="balance-item border-r border-gray-200 px-2">
                        <p class="text-[var(--color-pengeluaran)]"><i class="fas fa-arrow-up-long mr-1"> K E L U R</i></p>
                        <p id="totalPengeluaran" class="balance-value">0</p>
                    </div>
                    
                    <!-- Sisa Saldo -->
                    <div class="balance-item pl-2">
                        <p class="text-[var(--color-net-saldo)]"><i class="fas fa-balance-scale-left mr-1"> S A L D O</i></p>
                        <p id="akhirSaldoKategori" class="balance-value">0</p>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-3 text-center">
                    <p class="text-sm font-bold text-[var(--text-main)] mb-1">SISA SALDO SEMUA KATEGORI</p>
                    <p id="sisaSaldoSemuaKategori" class="font-extrabold mt-1 font-['JetBrains_Mono',_monospace]">0</p>
                </div>
            </div>
        </div>

        <!-- TABEL TRANSAKSI -->
        <div class="glass-card p-4 overflow-x-auto relative">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-semibold text-[var(--text-main)]">
                    <i class="fas fa-receipt mr-2"></i> Rincian :
                </h2>
                <div class="flex space-x-2">
                    <!-- Tombol CSV -->
                    <button 
                        id="tombolSimpanCsv" 
                        class="btn-primary flex items-center justify-center text-xs rounded-full transform transition duration-200"
                        style="width: 30px; height: 30px; font-size: 0.65rem; padding: 0;"
                        title="Simpan Data Transaksi Kategori Ini ke CSV"
                        onclick="exportToCSV()"
                    >
                        <i class="fas fa-download"></i>
                    </button>
                    <!-- Tombol Tambah -->
                    <button 
                        id="tombolTambahBaru" 
                        class="btn-primary rounded-full flex items-center justify-center transform transition duration-200" 
                        title="Tambah Transaksi Baru"
                        style="width: 30px; height: 30px; font-size: 0.65rem; padding: 0;"
                        onclick="addRowToTable()"
                    >
                        <i class="fas fa-plus-circle"></i>
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto scrollable-data shadow-inner bg-white bg-opacity-80">
                <table class="min-w-full data-table border-collapse">
                    <thead class="sticky top-0 z-10">
                        <tr>
                            <th class="px-3 py-2 text-xs uppercase tracking-wider hidden-ts-col">ID TRANSAKSI (TS)</th> 
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">TANGGAL</th>
                            <th class="px-6 py-2 text-center text-xs uppercase tracking-wider">KETERANGAN</th> 
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">PEMASUKAN</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">PENGELUARAN</th>
                            <th class="px-3 py-2 text-center text-xs uppercase tracking-wider">AKSI</th> 
                        </tr>
                    </thead>
                    <tbody id="tabelDataTransaksi" class="divide-y divide-[var(--border-color)]">
                        <tr><td colspan="6" class="text-center py-4 text-[var(--text-subtle)]">Silakan pilih kategori di atas.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL LOADING (MEMUAT) -->
    <div id="lapisanMemuat" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-full max-w-xs">
            <div class="flex items-center justify-center space-x-2">
                <svg class="animate-spin h-5 w-5 text-[var(--accent-1)]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-sm font-medium text-[var(--text-main)]">Memuat Data...</span>
            </div>
        </div>
    </div>

    <!-- KONTAINER TOAST (NOTIFIKASI KECIL) -->
    <div id="wadahToast" class="fixed bottom-4 right-4 space-y-2 z-50"></div>

    <!-- MODAL KONFIRMASI HAPUS -->
    <div id="modalHapus" class="modal fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="modal-content p-4 w-11/12 max-w-xs">
            <h3 class="text-lg font-bold mb-3 flex items-center text-[var(--color-delete)]">
                <i class="fas fa-exclamation-triangle mr-2"></i> Konfirmasi Penghapusan
            </h3>
            <p id="modalPesan" class="mb-4 text-[var(--text-main)] text-sm">Anda yakin ingin menghapus transaksi ini?</p>
            <div class="flex justify-end space-x-2">
                <button id="tombolBatalHapus" class="bg-gray-200 text-gray-700 font-semibold py-1.5 px-3 rounded-md text-sm hover:bg-gray-300 transition duration-150">
                    <i class="fas fa-times mr-1"></i> Batal
                </button>
                <button id="tombolKonfirmasiHapus" class="btn-delete text-white font-semibold py-1.5 px-3 rounded-md shadow-md hover:shadow-lg transition duration-150 ease-in-out text-sm">
                    <i class="fas fa-trash-alt mr-1"></i> Ya, Hapus
                </button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // =========================================================================
        // KONFIGURASI URL
        // Ganti URL di bawah ini dengan URL Web App Google Apps Script Anda yang baru
        // =========================================================================
        const GOOGLE_APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby0X7YsP1DjDkw6TjnUa27s-bhtNePtkSgHolBcp7W4LBMZxX82mUTIeBfSynSIzjezGA/exec"; 

        // Daftar Kategori (Ini akan menjadi nama Sheet di Spreadsheet)
        const CATEGORY_DATA = ["Mahar", "Mas Kawin", "Seserahan", "Souvenir", "Undangan", "Lain Lain"];
        
        // Variabel Global untuk Status Aplikasi
        let isEditing = false;          // Apakah sedang mode edit?
        let isAddingNew = false;        // Apakah sedang mode tambah baru?
        let originalRowContent = null;  // Menyimpan isi baris sebelum diedit (untuk cancel)
        let currentSelectedCategory = CATEGORY_DATA[0]; // Kategori aktif saat ini
        let transactionIdToDelete = null; // ID transaksi yang akan dihapus
        
        // Variabel untuk Menyimpan Nilai Saldo
        let finalBalanceCategoryValue = 0; 
        let totalIncomeValue = 0; 
        let totalExpenseValue = 0; 
        let globalFinalBalanceValue = 0; 
        
        // Referensi Elemen DOM (HTML)
        const filterBulanContainer = document.getElementById('filterBulanContainer'); 
        const tabelDataTransaksi = document.getElementById('tabelDataTransaksi');     
        const lapisanMemuat = document.getElementById('lapisanMemuat');             
        
        const akhirSaldoKategoriEl = document.getElementById('akhirSaldoKategori'); 
        const totalPemasukanEl = document.getElementById('totalPemasukan');         
        const totalPengeluaranEl = document.getElementById('totalPengeluaran');     
        const sisaSaldoSemuaKategoriEl = document.getElementById('sisaSaldoSemuaKategori'); 
        
        const tombolTambahBaru = document.getElementById('tombolTambahBaru');         
        const wadahToast = document.getElementById('wadahToast');                     
        const modalHapus = document.getElementById('modalHapus');                     
        const tombolKonfirmasiHapus = document.getElementById('tombolKonfirmasiHapus'); 
        const tombolBatalHapus = document.getElementById('tombolBatalHapus');           
        const tombolSimpanCsv = document.getElementById('tombolSimpanCsv');         

        // =========================================================================
        // FUNGSI KOMUNIKASI KE GOOGLE SHEETS (BACKEND)
        // =========================================================================
        async function postToGS(data) {
            // Cek apakah URL Script sudah diisi
            if (GOOGLE_APPS_SCRIPT_URL.includes("MASUKKAN_URL")) {
                showToast("Harap atur URL Google Apps Script di dalam kode HTML!", "error");
                return;
            }

            showLoading(true);
            const url = GOOGLE_APPS_SCRIPT_URL; 
            const MAX_RETRIES = 3; // Jumlah percobaan maksimal jika gagal

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const formData = new FormData();
                    for (const key in data) {
                        // Konversi angka ke string agar aman dikirim
                        formData.append(key, typeof data[key] === 'number' ? String(data[key]) : data[key]);
                    }

                    // Kirim data menggunakan Fetch API
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow',
                        mode: 'cors' // Penting untuk akses lintas domain
                    });

                    if (!response.ok) {
                        throw new Error(`Permintaan HTTP gagal dengan status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === 'error') {
                        throw new Error(result.message || 'Operasi gagal di sisi server.');
                    }
                    showLoading(false);
                    return result;

                } catch (error) {
                    console.error("Kesalahan saat menghubungi Apps Script:", error);
                    // Jika percobaan terakhir masih gagal, lempar error
                    if (i === MAX_RETRIES - 1) {
                        showLoading(false);
                        throw new Error(`Gagal memproses data setelah ${MAX_RETRIES} percobaan: ${error.message}`);
                    }
                    // Tunggu sebentar sebelum mencoba lagi (Exponential Backoff)
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay)); 
                }
            }
        }

        // Mengambil Saldo Global (Total Semua Kategori)
        async function fetchGlobalBalance() {
             try {
                const result = await postToGS({ action: 'READ_ALL_BALANCE', month: currentSelectedCategory }); 
                globalFinalBalanceValue = parseFloat(result.totalSaldo) || 0;
                updateSaldoDisplay();
            } catch (error) {
                console.error("Gagal memuat saldo global:", error);
                globalFinalBalanceValue = 0; 
                updateSaldoDisplay();
                // Jangan tampilkan toast error untuk saldo global agar tidak mengganggu UX
            }
        }

        // =========================================================================
        // FUNGSI UTILITAS (UI & FORMATTING)
        // =========================================================================
        
        // Menampilkan notifikasi (Toast)
        function showToast(message, type) {
            const container = wadahToast;
            let bgColor;
            let icon;
            
            if (type === 'success') {
                bgColor = 'bg-[var(--accent-1)]'; icon = 'fa-check-circle';
            } else if (type === 'accent-3') {
                bgColor = 'bg-[#08978b]'; icon = 'fa-info-circle';
            } else { 
                bgColor = 'bg-[var(--accent-2)]'; icon = 'fa-exclamation-circle';
            }

            const toast = document.createElement('div');
            toast.className = `p-2 rounded-lg shadow-xl ${bgColor} text-white transition-all transform duration-500 translate-y-2 opacity-0 flex items-center space-x-2 text-sm`;
            toast.innerHTML = `<i class="fas ${icon} text-lg"></i> <div> <p class="font-bold">${type === 'success' ? 'BERHASIL' : (type === 'accent-3' ? 'PERHATIAN' : 'GAGAL')}</p> <p class="mt-0.5 text-xs">${message}</p> </div>`;
            container.appendChild(toast);

            // Animasi masuk
            setTimeout(() => {
                toast.classList.remove('translate-y-2', 'opacity-0');
            }, 50); 
            
            // Animasi keluar dan hapus elemen setelah 5 detik
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => { toast.remove(); }, 500);
            }, 5000);
        }

        // Menampilkan/Menyembunyikan Loading Spinner
        function showLoading(state) {
            lapisanMemuat.classList.toggle('hidden', !state);
            lapisanMemuat.classList.toggle('modal-open', state);
        }

        // Format Angka ke Rupiah (tanpa simbol Rp untuk keringkasan)
        function formatAngka(angka) {
            if (typeof angka !== 'number' && typeof angka !== 'string') return '0';
            const num = typeof angka === 'string' ? parseFloat(angka) : angka;
            if (isNaN(num)) return '0';

            const formatter = new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0
            });
            const formatted = formatter.format(Math.abs(num));
            return num < 0 ? `-${formatted}` : formatted;
        }

        // Mengubah format Rupiah string kembali ke angka murni
        function parseRupiah(rupiahString) {
            const cleanString = rupiahString.replace(/[^0-9,-]/g, '').replace(',', '.'); 
            const number = parseFloat(cleanString);
            return isNaN(number) ? 0 : number;
        }

        // Format Tanggal: YYYY-MM-DD -> 17 Agustus 2024
        function formatDateToIndonesian(dateString) {
            if (!dateString) return '';
            try {
                const parts = dateString.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (!parts) return dateString;

                const date = new Date(parts[1], parts[2] - 1, parts[3]);
                
                return date.toLocaleDateString('id-ID', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                });
            } catch (e) {
                return dateString;
            }
        }

        // Format Tanggal Balik: 17 Agustus 2024 -> YYYY-MM-DD (untuk input date)
        function convertToYyyyMmDd(indonesianDateString) {
            // Fungsi sederhana, lebih baik gunakan data asli dari database jika memungkinkan
            // Karena parsing "17 Agustus 2024" secara manual cukup kompleks
            // Kita akan mencoba parsing standar JS
            try {
                // Trik: Ganti nama bulan Indonesia ke Inggris untuk Date.parse
                const monthsIndo = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                const monthsEng = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                
                let dateStr = indonesianDateString;
                monthsIndo.forEach((bln, idx) => {
                    dateStr = dateStr.replace(bln, monthsEng[idx]);
                });

                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return '';
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return '';
            }
        }
        
        // Membuat Elemen Input Dinamis (Text/Number/Date)
        function createInput(type, value, placeholder = '') {
            const input = document.createElement('input');
            
            if (type === 'number') {
                input.type = 'number';
                input.value = value || 0;
                input.min = 0;
                input.className = 'gaya-input-theme w-full text-center';
            } else if (type === 'date') {
                input.type = 'date';
                input.value = value || '';
                input.className = 'gaya-input-theme w-full text-center';
            } else { 
                input.type = 'text';
                input.value = value || '';
                input.className = 'gaya-input-theme w-full text-left'; 
            }
            input.placeholder = placeholder;
            return input;
        }

        // =========================================================================
        // FUNGSI UTAMA LOGIKA APLIKASI
        // =========================================================================

        // Mengambil Data dari Spreadsheet berdasarkan Kategori
        async function fetchData(category = currentSelectedCategory) {
            currentSelectedCategory = category; 
            showLoading(true);
            try {
                // Panggil API 'READ_DATA'
                const result = await postToGS({ action: 'READ_DATA', month: category });
                
                tabelDataTransaksi.innerHTML = ''; // Kosongkan tabel
                
                const data = result.data || [];
                
                let tempIncome = 0;
                let tempExpense = 0;
                const colspanValue = 6; 

                if (data.length === 0) {
                    // Tampilkan pesan jika data kosong
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="${colspanValue}" class="text-center py-4 text-[var(--text-subtle)]">Tidak ada data transaksi untuk kategori ${category}.</td>`;
                    tabelDataTransaksi.appendChild(noDataRow);
                    
                    finalBalanceCategoryValue = 0; 
                    totalIncomeValue = 0;
                    totalExpenseValue = 0;
                } else {
                    // Loop data dan masukkan ke tabel
                    data.forEach(rowData => {
                        tabelDataTransaksi.appendChild(createTableRow(rowData));
                        
                        // Akumulasi total pemasukan/pengeluaran
                        tempIncome += parseFloat(rowData[3]) || 0;
                        tempExpense += parseFloat(rowData[4]) || 0;
                    });
                    
                    // Saldo akhir diambil dari baris terakhir kolom saldo (index 5)
                    finalBalanceCategoryValue = parseFloat(data[data.length - 1][5]) || 0; 
                    totalIncomeValue = tempIncome;
                    totalExpenseValue = tempExpense;
                }
                
                // Perbarui saldo global juga
                await fetchGlobalBalance(); 
                
                updateSaldoDisplay();
                updateCategoryButtons(category); 

            } catch (error) {
                showToast(`Gagal memuat data: ${error.message}`, 'error');
                tabelDataTransaksi.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">${error.message}</td></tr>`;
                finalBalanceCategoryValue = 0;
                totalIncomeValue = 0;
                totalExpenseValue = 0;
                updateSaldoDisplay();
            } finally {
                showLoading(false);
                isEditing = false;
                isAddingNew = false;
            }
        }

        // Memperbarui Tampilan Angka Saldo di Kartu Atas
        function updateSaldoDisplay() {
            totalPemasukanEl.textContent = formatAngka(totalIncomeValue);
            totalPengeluaranEl.textContent = formatAngka(totalExpenseValue);

            akhirSaldoKategoriEl.textContent = formatAngka(finalBalanceCategoryValue);
            // Warna merah jika minus, biru jika plus
            akhirSaldoKategoriEl.style.color = finalBalanceCategoryValue < 0 ? 'var(--color-delete)' : 'var(--color-net-saldo)';
            
            sisaSaldoSemuaKategoriEl.textContent = formatAngka(globalFinalBalanceValue);
            sisaSaldoSemuaKategoriEl.style.color = globalFinalBalanceValue < 0 ? 'var(--color-delete)' : 'var(--color-global-saldo)';
        }

        // Membuat Baris Tabel HTML dari Data
        function createTableRow(rowData) {
            // rowData format: [id, tanggal, keterangan, pemasukan, pengeluaran, saldo]
            const [id, tanggal, keterangan, pemasukan, pengeluaran, saldo] = rowData;

            const row = document.createElement('tr');
            row.dataset.id = id;

            // Kolom ID (Tersembunyi)
            const tdId = document.createElement('td');
            tdId.className = 'hidden-ts-col';
            tdId.textContent = id;
            row.appendChild(tdId);

            // Kolom Data
            row.appendChild(createDataCell(formatDateToIndonesian(tanggal), 'text-center'));
            row.appendChild(createDataCell(keterangan, 'text-left')); 
            row.appendChild(createDataCell(formatAngka(pemasukan), 'text-right'));
            row.appendChild(createDataCell(formatAngka(pengeluaran), 'text-right'));

            // Kolom Aksi
            const tdAksi = document.createElement('td');
            tdAksi.className = 'text-center';
            tdAksi.innerHTML = `
                <div class="table-action-container">
                    <button
                        class="btn-table-action bg-[var(--color-edit)] hover:bg-opacity-80"
                        title="Edit Transaksi"
                        onclick="startEdit('${id}')"
                    >
                        <i class="fas fa-pen"></i>
                    </button>
                    <button
                        class="btn-table-action bg-[var(--color-delete)] hover:bg-opacity-80"
                        title="Hapus Transaksi"
                        onclick="showDeleteConfirmation('${id}')"
                    >
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            row.appendChild(tdAksi);

            return row;
        }

        function createDataCell(content, extraClass = '') {
            const td = document.createElement('td');
            td.textContent = content;
            td.className = extraClass;
            return td;
        }

        // Memulai Mode Tambah Data Baru
        function addRowToTable() {
            if (isAddingNew || isEditing) {
                showToast("Selesaikan input/edit yang aktif terlebih dahulu.", 'accent-3');
                return;
            }

            isAddingNew = true;

            const newRow = document.createElement('tr');
            newRow.id = 'baris-input-baru';
            newRow.dataset.id = 'NEW';

            newRow.innerHTML += '<td class="hidden-ts-col">NEW</td>';

            // Input Tanggal (Default hari ini)
            const tanggalTd = document.createElement('td');
            const today = new Date().toISOString().split('T')[0];
            const tanggalInput = createInput('date', today);
            tanggalTd.appendChild(tanggalInput);
            newRow.appendChild(tanggalTd);

            // Input Keterangan
            const keteranganTd = document.createElement('td');
            const keteranganInput = createInput('text', '', 'Contoh: Emas 10 gram'); 
            keteranganTd.appendChild(keteranganInput);
            newRow.appendChild(keteranganTd);

            // Input Pemasukan
            const pemasukanTd = document.createElement('td');
            const pemasukanInput = createInput('number', 0, 'Pemasukan');
            pemasukanTd.appendChild(pemasukanInput);
            newRow.appendChild(pemasukanTd);

            // Input Pengeluaran
            const pengeluaranTd = document.createElement('td');
            const pengeluaranInput = createInput('number', 0, 'Pengeluaran');
            pengeluaranTd.appendChild(pengeluaranInput);
            newRow.appendChild(pengeluaranTd);
            
            // Tombol Simpan/Batal
            const aksiTd = document.createElement('td');
            aksiTd.className = 'text-center';
            aksiTd.innerHTML = `
                <div class="table-action-container">
                    <button
                        class="btn-table-action bg-[var(--color-save)] hover:bg-opacity-80"
                        title="Simpan Transaksi Baru"
                        onclick="saveNewData()"
                    >
                        <i class="fas fa-check"></i>
                    </button>
                    <button
                        class="btn-table-action bg-gray-400 hover:bg-gray-500"
                        title="Batal Input"
                        onclick="cancelAction('NEW')"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            newRow.appendChild(aksiTd);

            // Masukkan baris baru di paling atas tabel
            tabelDataTransaksi.insertBefore(newRow, tabelDataTransaksi.firstChild);
            tanggalInput.focus();
        }

        // Memulai Mode Edit
        function startEdit(id) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan input/edit yang aktif terlebih dahulu.", 'accent-3');
                return;
            }

            isEditing = true;
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;

            row.classList.add('baris-edit-aktif');
            originalRowContent = row.innerHTML; // Simpan konten lama

            const cells = Array.from(row.querySelectorAll('td'));
            const dataCells = cells.slice(1, 5); // Ambil sel data saja
            const aksiCell = cells[5]; 

            // Ambil nilai lama
            const currentDate = dataCells[0].textContent; 
            const currentKeterangan = dataCells[1].textContent; 
            const currentPemasukan = parseRupiah(dataCells[2].textContent); 
            const currentPengeluaran = parseRupiah(dataCells[3].textContent); 

            // Ganti teks dengan Input
            const tanggalInput = createInput('date', convertToYyyyMmDd(currentDate));
            dataCells[0].textContent = '';
            dataCells[0].appendChild(tanggalInput);

            const keteranganInput = createInput('text', currentKeterangan);
            dataCells[1].textContent = '';
            dataCells[1].appendChild(keteranganInput);

            const pemasukanInput = createInput('number', currentPemasukan);
            dataCells[2].textContent = '';
            dataCells[2].appendChild(pemasukanInput);

            const pengeluaranInput = createInput('number', currentPengeluaran);
            dataCells[3].textContent = '';
            dataCells[3].appendChild(pengeluaranInput);

            // Ganti tombol aksi
            aksiCell.innerHTML = `
                <div class="table-action-container">
                    <button
                        class="btn-table-action bg-[var(--color-save)] hover:bg-opacity-80"
                        title="Simpan Perubahan"
                        onclick="updateData('${id}')"
                    >
                        <i class="fas fa-check"></i>
                    </button>
                    <button
                        class="btn-table-action bg-gray-400 hover:bg-gray-500"
                        title="Batal Edit"
                        onclick="cancelAction('${id}')"
                    >
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            tanggalInput.focus();
        }

        // Simpan Data Baru ke Spreadsheet
        async function saveNewData() {
            const row = document.getElementById('baris-input-baru');
            if (!row) return;
            
            const tanggal = row.querySelector('input[type="date"]').value;
            const keterangan = row.querySelector('td:nth-child(3) input').value; 
            const pemasukan = parseFloat(row.querySelectorAll('input[type="number"]')[0].value) || 0;
            const pengeluaran = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;
            
            if (!tanggal || !keterangan) {
                showToast("Harap isi Tanggal dan Keterangan (deskripsi transaksi).", 'accent-3');
                return;
            }

            try {
                const dataToSend = {
                    action: 'ADD_TRANSACTION',
                    month: currentSelectedCategory, 
                    tanggal,
                    keterangan,
                    pemasukan,
                    pengeluaran
                };

                await postToGS(dataToSend);
                showToast("Transaksi berhasil ditambahkan!", 'success');
                isAddingNew = false;
                fetchData(currentSelectedCategory); 
            } catch (error) {
                showToast(`Gagal menambahkan: ${error.message}`, 'error');
            }
        }

        // Update Data ke Spreadsheet
        async function updateData(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            if (!row) return;

            const tanggal = row.querySelector('input[type="date"]').value;
            const keterangan = row.querySelector('td:nth-child(3) input').value; 
            const pemasukan = parseFloat(row.querySelectorAll('input[type="number"]')[0].value) || 0;
            const pengeluaran = parseFloat(row.querySelectorAll('input[type="number"]')[1].value) || 0;

            if (!tanggal || !keterangan) {
                showToast("Harap isi Tanggal dan Keterangan.", 'accent-3');
                return;
            }

            try {
                const dataToSend = {
                    action: 'UPDATE_TRANSACTION',
                    id: id,
                    month: currentSelectedCategory, 
                    tanggal,
                    keterangan,
                    pemasukan,
                    pengeluaran
                };

                await postToGS(dataToSend);
                showToast("Transaksi berhasil diperbarui!", 'success');
                isEditing = false;
                fetchData(currentSelectedCategory); 
            } catch (error) {
                showToast(`Gagal memperbarui: ${error.message}`, 'error');
            }
        }

        // Konfirmasi Hapus
        function showDeleteConfirmation(id) {
            if (isEditing || isAddingNew) {
                showToast("Selesaikan input/edit yang aktif terlebih dahulu.", 'accent-3');
                return;
            }
            transactionIdToDelete = id;
            modalHapus.classList.remove('hidden');
            modalHapus.classList.add('modal-open');
        }

        // Eksekusi Hapus
        async function deleteTransaction() {
            modalHapus.classList.remove('modal-open');
            modalHapus.classList.add('hidden');

            if (!transactionIdToDelete) return;

            try {
                await postToGS({ 
                    action: 'DELETE_TRANSACTION', 
                    id: transactionIdToDelete,
                    month: currentSelectedCategory 
                });
                showToast("Transaksi berhasil dihapus!", 'success');
                transactionIdToDelete = null;
                fetchData(currentSelectedCategory); 
            } catch (error) {
                showToast(`Gagal menghapus: ${error.message}`, 'error');
            }
        }

        // Batal Input/Edit
        function cancelAction(id) {
            if (id === 'NEW') {
                const newRow = document.getElementById('baris-input-baru');
                if (newRow) newRow.remove();
                isAddingNew = false;
            } else {
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (row && originalRowContent) {
                    row.innerHTML = originalRowContent;
                    row.classList.remove('baris-edit-aktif');
                    isEditing = false;
                    originalRowContent = null;
                }
            }
        }

        // Membuat Tombol Kategori
        function createCategoryButton(categoryName) {
            const button = document.createElement('button');
            button.textContent = categoryName; 
            button.className = 'btn-month-theme text-xs'; 
            button.onclick = () => fetchData(categoryName);
            return button;
        }

        // Highlight Tombol Kategori Aktif
        function updateCategoryButtons(activeCategory) {
            Array.from(filterBulanContainer.children).forEach(btn => {
                btn.classList.toggle('aktif', btn.textContent === activeCategory);
            });
        }
        
        // Fitur Export ke CSV
        function exportToCSV() {
            const table = document.querySelector('.data-table');
            if (!table) return;

            let csv = [];
            // Ambil header tabel
            const headers = Array.from(table.querySelectorAll('thead th:not(.hidden-ts-col)'))
                                .map(th => th.textContent.trim());
            const dataHeaders = headers.slice(0, headers.length - 1); 
            dataHeaders.push('SALDO');
            csv.push(dataHeaders.join(';')); 
            
            showLoading(true);

            // Ambil data mentah dari server agar akurat
            postToGS({ action: 'READ_DATA', month: currentSelectedCategory })
                .then(result => {
                    const rawData = result.data || [];
                    
                    if (rawData.length === 0) {
                        showLoading(false);
                        showToast(`Tidak ada data untuk diekspor di kategori ${currentSelectedCategory}.`, 'accent-3');
                        return;
                    }

                    rawData.forEach(rowData => {
                        // Buang ID di index 0
                        const rowDataToExport = rowData.slice(1); 
                        
                        const formattedData = rowDataToExport.map(d => {
                            if (typeof d === 'string') {
                                const isNegative = d.includes('-');
                                const cleanD = d.replace(/[^0-9,.]/g, '').replace(',', '.');
                                return !isNaN(parseFloat(cleanD)) ? (isNegative ? `-${cleanD.replace('-', '')}` : cleanD) : d;
                            }
                            return String(d).replace(/\./g, '').replace(',', '.');
                        });
                        
                        if (formattedData.length === 5) { 
                             csv.push(formattedData.join(';'));
                        }
                    });

                    const csvString = csv.join('\n');
                    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    const url = URL.createObjectURL(blob);
                    
                    link.setAttribute("href", url);
                    link.setAttribute("download", `Keuangan_${currentSelectedCategory}.csv`);
                    link.style.visibility = 'hidden';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast("Data berhasil diekspor ke CSV!", 'success');
                    showLoading(false);

                })
                .catch(error => {
                    showLoading(false);
                    showToast(`Gagal mengekspor data: ${error.message}`, 'error');
                });
        }

        // Inisialisasi Saat Halaman Dimuat
        function initialize() {
            // Buat tombol kategori
            CATEGORY_DATA.forEach(category => {
                filterBulanContainer.appendChild(createCategoryButton(category));
            });

            // Event Listener Modal Hapus
            tombolKonfirmasiHapus.onclick = deleteTransaction;
            tombolBatalHapus.onclick = () => {
                modalHapus.classList.remove('modal-open');
                modalHapus.classList.add('hidden');
                transactionIdToDelete = null;
            };

            // Ambil data pertama kali
            fetchData();
        }

        // Jalankan Inisialisasi
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Ekspos fungsi ke window agar bisa diakses oleh onclick di HTML
        window.startEdit = startEdit;
        window.showDeleteConfirmation = showDeleteConfirmation;
        window.addRowToTable = addRowToTable;
        window.cancelAction = cancelAction;
        window.updateData = updateData; 
        window.saveNewData = saveNewData; 
        window.exportToCSV = exportToCSV; 

    </script>
</body>
</html>
